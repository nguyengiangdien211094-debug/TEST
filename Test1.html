<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω L·ªánh C√¥ng T√°c (Ph·ª• L·ª•c B)</title>
    <style>
        /* CSS: ƒê·ªãnh d·∫°ng giao di·ªán gi·ªëng vƒÉn b·∫£n in ·∫•n */
        body { font-family: 'Times New Roman', Times, serif; background-color: #f4f4f4; padding: 20px; font-size: 14px; }
        .container { max-width: 900px; margin: 0 auto; background: #fff; padding: 40px; box-shadow: 0 0 15px rgba(0,0,0,0.1); border: 1px solid #ddd; }
        
        /* Ti√™u ƒë·ªÅ */
        h1, h2, h3 { text-align: center; font-weight: bold; text-transform: uppercase; margin: 10px 0; }
        h1 { font-size: 18pt; }
        h3 { font-size: 14pt; margin-top: 30px; background: #eee; padding: 5px; text-align: left; border-left: 5px solid #333; }
        
        /* Layout h√†ng v√† c·ªôt */
        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .col { flex: 1; }
        
        /* C√°c √¥ nh·∫≠p li·ªáu */
        label { font-weight: bold; margin-right: 5px; display: inline-block; }
        input[type="text"], input[type="number"], input[type="datetime-local"], textarea {
            border: 1px solid #ccc; padding: 5px; border-radius: 3px; width: 100%; box-sizing: border-box; font-family: inherit;
        }
        /* Input ki·ªÉu d√≤ng k·∫ª (cho gi·ªëng vƒÉn b·∫£n) */
        .input-line { border: none; border-bottom: 1px dotted #000; background: transparent; padding: 2px; font-weight: bold; color: #000; }
        .input-line:focus { outline: none; border-bottom: 2px solid #007bff; }
        
        textarea { height: 60px; resize: vertical; border: 1px solid #bbb; width: 100%; display: block; margin-top: 5px; }

        /* B·∫£ng bi·ªÉu */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; margin-bottom: 15px; }
        th, td { border: 1px solid #000; padding: 8px; text-align: center; vertical-align: middle; }
        th { background-color: #f0f0f0; font-weight: bold; }
        
        /* Ph·∫ßn ch·ªØ k√Ω */
        .signature-section { display: flex; justify-content: space-around; margin-top: 40px; text-align: center; }
        .signature-box { width: 40%; }
        .signature-box p { margin: 5px 0; font-style: italic; }
        
        /* Thanh c√¥ng c·ª• (N√∫t b·∫•m) */
        .toolbar {
            position: fixed; bottom: 20px; right: 20px; 
            background: rgba(0, 0, 0, 0.8); padding: 15px; border-radius: 8px;
            display: flex; gap: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 1000;
        }
        button {
            padding: 10px 20px; cursor: pointer; border: none; border-radius: 4px; 
            font-weight: bold; color: white; transition: 0.3s;
        }
        .btn-save { background-color: #28a745; }
        .btn-save:hover { background-color: #218838; }
        .btn-load { background-color: #007bff; }
        .btn-load:hover { background-color: #0069d9; }
        
        /* Tr·∫°ng th√°i */
        #statusMsg { color: white; margin-right: 10px; align-self: center; font-style: italic; }
        
        @media print {
            .toolbar { display: none; }
            body { background: white; padding: 0; }
            .container { box-shadow: none; border: none; padding: 0; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="row">
        <div style="width: 40%;">
            T√äN ƒê∆†N V·ªä C·∫§P L·ªÜNH:<br>
            <input type="text" id="donViCapLenh" class="input-line" placeholder="...">
        </div>
        <div style="width: 60%; text-align: center;">
            <h2>L·ªÜNH C√îNG T√ÅC</h2>
            S·ªë: <input type="text" id="soLenh" class="input-line" style="width: 100px; text-align: center;" placeholder="Nh·∫≠p s·ªë l·ªánh">
        </div>
    </div>

    <h3>A. PH·∫¶N L∆ØU GI·ªÆ C·ª¶A NG∆Ø·ªúI RA L·ªÜNH [cite: 2]</h3>
    
    <div>
        <label>1. Ng∆∞·ªùi ch·ªâ huy tr·ª±c ti·∫øp:</label> 
        <input type="text" id="nguoiChiHuyA" class="input-line" style="width: 50%;"> 
        <label>B·∫≠c ATƒê:</label> <input type="number" id="bacAtA" class="input-line" style="width: 50px;">/5
    </div>

    <div style="margin-top: 10px;">
        <label>2. Nh√¢n vi√™n ƒë∆°n v·ªã c√¥ng t√°c g·ªìm:</label> 
        <input type="number" id="soLuongNguoiA" class="input-line" style="width: 50px;"> ng∆∞·ªùi. 
        <label>Thu·ªôc:</label> <input type="text" id="donViCongTacA" class="input-line" style="width: 40%;">
    </div>

    <p><b>Danh s√°ch nh√¢n vi√™n:</b></p>
    <table id="tableNhanVienA">
        <thead>
            <tr>
                <th width="10%">TT</th>
                <th>H·ªç v√† t√™n</th>
                <th width="20%">B·∫≠c ATƒê</th>
            </tr>
        </thead>
        <tbody>
            <tr><td>1</td><td><input type="text" class="staff-name"></td><td><input type="number" class="staff-safety"></td></tr>
            <tr><td>2</td><td><input type="text" class="staff-name"></td><td><input type="number" class="staff-safety"></td></tr>
            <tr><td>3</td><td><input type="text" class="staff-name"></td><td><input type="number" class="staff-safety"></td></tr>
        </tbody>
    </table>

    <div>
        <label>3. ƒê·ªãa ƒëi·ªÉm/Thi·∫øt b·ªã c√¥ng t√°c:</label> 
        <textarea id="diaDiemA" placeholder="Nh·∫≠p ƒë·ªãa ƒëi·ªÉm..."></textarea>
    </div>
    <div>
        <label>4. N·ªôi dung c√¥ng t√°c:</label> 
        <textarea id="noiDungA" placeholder="Nh·∫≠p n·ªôi dung..."></textarea>
    </div>
    <div>
        <label>5. ƒêi·ªÅu ki·ªán an to√†n ƒëi·ªán:</label> 
        <textarea id="dieuKienA" placeholder="C·∫Øt ƒëi·ªán, ti·∫øp ƒë·ªãa..."></textarea>
    </div>
    <div style="margin-top: 10px;">
        <label>6. Th·ªùi gian b·∫Øt ƒë·∫ßu (D·ª± ki·∫øn):</label> 
        <input type="datetime-local" id="thoiGianBatDauA" style="width: auto;">
    </div>

    <div class="signature-section">
        <div class="signature-box" style="margin-left: auto;">
            <b>Ng∆∞·ªùi ra l·ªánh c√¥ng t√°c</b><br>
            <i>(K√Ω, ghi h·ªç t√™n)</i><br><br><br>
            <input type="text" id="kyNguoiRaLenhA" class="input-line" style="text-align: center;" placeholder="H·ªç t√™n ng∆∞·ªùi k√Ω">
        </div>
    </div>

    <hr style="margin: 40px 0; border-top: 2px dashed #999;">

    <h3>B. PH·∫¶N GIAO CHO NG∆Ø·ªúI CH·ªà HUY TR·ª∞C TI·∫æP [cite: 4]</h3>
    
    <p><i>(C√°c m·ª•c 1.1, 1.2, 1.3, 1.4, 1.5 c√≥ th·ªÉ t·ª± ƒë·ªông l·∫•y t·ª´ Ph·∫ßn A n·∫øu c·∫ßn)</i></p>

    <p><b>Danh s√°ch nh√¢n vi√™n v√† thay ƒë·ªïi ng∆∞·ªùi (n·∫øu c√≥)[cite: 5]:</b></p>
    <table id="tableNhanVienB">
        <thead>
            <tr>
                <th rowspan="2">TT</th>
                <th rowspan="2">H·ªç t√™n</th>
                <th rowspan="2">B·∫≠c ATƒê</th>
                <th colspan="2">ƒê·∫øn l√†m vi·ªác</th>
                <th colspan="2">R√∫t kh·ªèi</th>
            </tr>
            <tr>
                <th>Th·ªùi gian</th>
                <th>K√Ω t√™n</th>
                <th>Th·ªùi gian</th>
                <th>K√Ω t√™n</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>1</td>
                <td><input type="text" class="b-name"></td>
                <td><input type="number" class="b-safety"></td>
                <td><input type="text" class="b-arr-time" placeholder="Gi·ªù, ng√†y"></td>
                <td><input type="text" class="b-arr-sign"></td>
                <td><input type="text" class="b-dep-time" placeholder="Gi·ªù, ng√†y"></td>
                <td><input type="text" class="b-dep-sign"></td>
            </tr>
             <tr>
                <td>2</td>
                <td><input type="text" class="b-name"></td>
                <td><input type="number" class="b-safety"></td>
                <td><input type="text" class="b-arr-time" placeholder="Gi·ªù, ng√†y"></td>
                <td><input type="text" class="b-arr-sign"></td>
                <td><input type="text" class="b-dep-time" placeholder="Gi·ªù, ng√†y"></td>
                <td><input type="text" class="b-dep-sign"></td>
            </tr>
        </tbody>
    </table>

    <div style="margin-top: 15px;">
        <label>1.6. Th·ªùi gian b·∫Øt ƒë·∫ßu l√†m vi·ªác (Th·ª±c t·∫ø):</label> 
        <input type="datetime-local" id="thoiGianBatDauB" style="width: auto;">
    </div>

    <h4 style="margin-top: 20px;">2. Th·ª±c hi·ªán l·ªánh [cite: 8]</h4>
    <div>
        <label>2.2. Ng∆∞·ªùi gi√°m s√°t an to√†n (n·∫øu c√≥):</label> 
        <input type="text" id="nguoiGiamSat" class="input-line" style="width: 40%;">
    </div>
    
    <p><b>2.3. Tr√¨nh t·ª± c√¥ng vi·ªác v√† ƒëi·ªÅu ki·ªán an to√†n[cite: 11]:</b></p>
    <table id="tableTrinhTu">
        <thead>
            <tr>
                <th width="5%">TT</th>
                <th>Tr√¨nh t·ª± c√¥ng vi·ªác</th>
                <th>C√°c ƒëi·ªÅu ki·ªán an to√†n</th>
                <th>TG B·∫Øt ƒë·∫ßu</th>
                <th>TG K·∫øt th√∫c</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>1</td>
                <td><input type="text" class="seq-work"></td>
                <td><input type="text" class="seq-safe"></td>
                <td><input type="text" class="seq-start" placeholder="Gi·ªù:Ph√∫t"></td>
                <td><input type="text" class="seq-end" placeholder="Gi·ªù:Ph√∫t"></td>
            </tr>
            <tr>
                <td>2</td>
                <td><input type="text" class="seq-work"></td>
                <td><input type="text" class="seq-safe"></td>
                <td><input type="text" class="seq-start" placeholder="Gi·ªù:Ph√∫t"></td>
                <td><input type="text" class="seq-end" placeholder="Gi·ªù:Ph√∫t"></td>
            </tr>
        </tbody>
    </table>

    <h4 style="margin-top: 20px;">3. K·∫øt th√∫c c√¥ng t√°c [cite: 12]</h4>
    <div>
        <label>ƒê∆°n v·ªã l√†m xong c√¥ng vi·ªác l√∫c:</label> 
        <input type="datetime-local" id="thoiGianKetThuc" style="width: auto;">
    </div>
    <div style="margin-top: 5px;">
        <label>ƒê√£ b√°o cho √¥ng (b√†):</label> 
        <input type="text" id="baoCaoCho" class="input-line" style="width: 30%;">
        <label>Ch·ª©c danh:</label> 
        <input type="text" id="chucDanhBaoCao" class="input-line" style="width: 20%;">
    </div>

    <div class="signature-section">
        <div class="signature-box">
            <b>Ng∆∞·ªùi ch·ªâ huy tr·ª±c ti·∫øp</b><br>
            <i>(K√Ω, ghi h·ªç t√™n)</i><br><br><br>
            <input type="text" id="kyNguoiChiHuyCuoi" class="input-line">
        </div>
        <div class="signature-box">
            <b>Ng∆∞·ªùi ra l·ªánh c√¥ng t√°c</b><br>
            <i>(ƒê√£ ki·ªÉm tra, k√Ω t√™n)</i><br><br><br>
            <input type="text" id="kyNguoiRaLenhCuoi" class="input-line">
        </div>
    </div>

</div>

<div class="toolbar">
    <span id="statusMsg">S·∫µn s√†ng</span>
    <button class="btn-load" onclick="loadData()">üìÇ T√¨m & Xem l·∫°i</button>
    <button class="btn-save" onclick="saveData()">üíæ L∆∞u L·ªánh</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
    // --- 1. C·∫§U H√åNH FIREBASE (B·∫†N PH·∫¢I THAY TH·∫æ PH·∫¶N N√ÄY) ---
    const firebaseConfig = {
        apiKey: "THAY_API_KEY_CUA_BAN_VAO_DAY",
        authDomain: "ten-du-an.firebaseapp.com",
        databaseURL: "https://ten-du-an-default-rtdb.firebaseio.com",
        projectId: "ten-du-an",
        storageBucket: "ten-du-an.appspot.com",
        messagingSenderId: "123456789",
        appId: "1:123456789:web:abcdef"
    };

    // Kh·ªüi t·∫°o Firebase
    let db;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
        console.log("ƒê√£ k·∫øt n·ªëi Firebase");
    } catch (e) {
        console.error("L·ªói Firebase:", e);
        document.getElementById('statusMsg').innerText = "L·ªói C·∫•u h√¨nh Firebase!";
    }

    // --- 2. H√ÄM L∆ØU D·ªÆ LI·ªÜU ---
    function saveData() {
        const soLenh = document.getElementById('soLenh').value.trim();
        if (!soLenh) {
            alert("Vui l√≤ng nh·∫≠p S·ªê L·ªÜNH ƒë·ªÉ l√†m kh√≥a l∆∞u tr·ªØ!");
            return;
        }

        document.getElementById('statusMsg').innerText = "ƒêang l∆∞u...";

        // Thu th·∫≠p d·ªØ li·ªáu t·ª´ c√°c tr∆∞·ªùng (ƒê√¢y ch·ªâ l√† v√≠ d·ª• c√°c tr∆∞·ªùng ch√≠nh)
        const data = {
            donViCapLenh: document.getElementById('donViCapLenh').value,
            phanA: {
                nguoiChiHuy: document.getElementById('nguoiChiHuyA').value,
                bacAt: document.getElementById('bacAtA').value,
                soLuong: document.getElementById('soLuongNguoiA').value,
                donVi: document.getElementById('donViCongTacA').value,
                diaDiem: document.getElementById('diaDiemA').value,
                noiDung: document.getElementById('noiDungA').value,
                dieuKien: document.getElementById('dieuKienA').value,
                thoiGianBatDau: document.getElementById('thoiGianBatDauA').value,
                nguoiKy: document.getElementById('kyNguoiRaLenhA').value,
                // Thu th·∫≠p b·∫£ng nh√¢n vi√™n A (v√≠ d·ª• d√≤ng 1)
                nhanVien: Array.from(document.querySelectorAll('#tableNhanVienA tbody tr')).map(row => ({
                    ten: row.querySelector('.staff-name').value,
                    bac: row.querySelector('.staff-safety').value
                }))
            },
            phanB: {
                thoiGianThucTe: document.getElementById('thoiGianBatDauB').value,
                // Thu th·∫≠p b·∫£ng B (R√∫t g·ªçn cho v√≠ d·ª•)
                nhanVienChiTiet: Array.from(document.querySelectorAll('#tableNhanVienB tbody tr')).map(row => ({
                    ten: row.querySelector('.b-name').value,
                    bac: row.querySelector('.b-safety').value,
                    den: row.querySelector('.b-arr-time').value,
                    di: row.querySelector('.b-dep-time').value
                }))
            },
            ketThuc: {
                nguoiGiamSat: document.getElementById('nguoiGiamSat').value,
                thoiGianKetThuc: document.getElementById('thoiGianKetThuc').value,
                baoCaoCho: document.getElementById('baoCaoCho').value,
                kyChiHuy: document.getElementById('kyNguoiChiHuyCuoi').value,
                kyRaLenh: document.getElementById('kyNguoiRaLenhCuoi').value,
                trinhTu: Array.from(document.querySelectorAll('#tableTrinhTu tbody tr')).map(row => ({
                    congViec: row.querySelector('.seq-work').value,
                    anToan: row.querySelector('.seq-safe').value
                }))
            },
            lastUpdated: new Date().toISOString()
        };

        // G·ª≠i l√™n Firebase: S·ª≠ d·ª•ng S·ªë l·ªánh l√†m ID
        db.ref('LenhCongTac/' + soLenh).set(data)
            .then(() => {
                document.getElementById('statusMsg').innerText = "ƒê√£ l∆∞u l√∫c " + new Date().toLocaleTimeString();
                alert("L∆∞u th√†nh c√¥ng l·ªánh s·ªë: " + soLenh);
            })
            .catch((error) => {
                alert("L·ªói: " + error.message);
                document.getElementById('statusMsg').innerText = "L·ªói khi l∆∞u";
            });
    }

    // --- 3. H√ÄM T·∫¢I D·ªÆ LI·ªÜU ---
    function loadData() {
        const soLenh = prompt("Nh·∫≠p S·ªê L·ªÜNH mu·ªën xem l·∫°i:");
        if (!soLenh) return;

        document.getElementById('statusMsg').innerText = "ƒêang t·∫£i...";
        
        db.ref('LenhCongTac/' + soLenh).once('value').then((snapshot) => {
            const data = snapshot.val();
            if (!data) {
                alert("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho l·ªánh s·ªë: " + soLenh);
                document.getElementById('statusMsg').innerText = "Kh√¥ng t√¨m th·∫•y";
                return;
            }

            // ƒêi·ªÅn l·∫°i d·ªØ li·ªáu v√†o form
            document.getElementById('soLenh').value = soLenh;
            document.getElementById('donViCapLenh').value = data.donViCapLenh || "";
            
            // Ph·∫ßn A
            if (data.phanA) {
                document.getElementById('nguoiChiHuyA').value = data.phanA.nguoiChiHuy || "";
                document.getElementById('bacAtA').value = data.phanA.bacAt || "";
                document.getElementById('soLuongNguoiA').value = data.phanA.soLuong || "";
                document.getElementById('donViCongTacA').value = data.phanA.donVi || "";
                document.getElementById('diaDiemA').value = data.phanA.diaDiem || "";
                document.getElementById('noiDungA').value = data.phanA.noiDung || "";
                document.getElementById('dieuKienA').value = data.phanA.dieuKien || "";
                document.getElementById('thoiGianBatDauA').value = data.phanA.thoiGianBatDau || "";
                document.getElementById('kyNguoiRaLenhA').value = data.phanA.nguoiKy || "";
                
                // ƒêi·ªÅn b·∫£ng nh√¢n vi√™n A
                if(data.phanA.nhanVien) {
                    const rows = document.querySelectorAll('#tableNhanVienA tbody tr');
                    data.phanA.nhanVien.forEach((nv, index) => {
                        if(rows[index]) {
                            rows[index].querySelector('.staff-name').value = nv.ten || "";
                            rows[index].querySelector('.staff-safety').value = nv.bac || "";
                        }
                    });
                }
            }

            // Ph·∫ßn B & K·∫øt th√∫c
            if (data.phanB) {
                document.getElementById('thoiGianBatDauB').value = data.phanB.thoiGianThucTe || "";
                // ƒêi·ªÅn b·∫£ng B t∆∞∆°ng t·ª± (code r√∫t g·ªçn cho ng·∫Øn)...
                if(data.phanB.nhanVienChiTiet) {
                     const rows = document.querySelectorAll('#tableNhanVienB tbody tr');
                     data.phanB.nhanVienChiTiet.forEach((nv, index) => {
                        if(rows[index]) {
                            rows[index].querySelector('.b-name').value = nv.ten || "";
                            rows[index].querySelector('.b-safety').value = nv.bac || "";
                            rows[index].querySelector('.b-arr-time').value = nv.den || "";
                            rows[index].querySelector('.b-dep-time').value = nv.di || "";
                        }
                     });
                }
            }
            if (data.ketThuc) {
                document.getElementById('nguoiGiamSat').value = data.ketThuc.nguoiGiamSat || "";
                document.getElementById('thoiGianKetThuc').value = data.ketThuc.thoiGianKetThuc || "";
                document.getElementById('baoCaoCho').value = data.ketThuc.baoCaoCho || "";
                document.getElementById('kyNguoiChiHuyCuoi').value = data.ketThuc.kyChiHuy || "";
                document.getElementById('kyNguoiRaLenhCuoi').value = data.ketThuc.kyRaLenh || "";
                
                 if(data.ketThuc.trinhTu) {
                     const rows = document.querySelectorAll('#tableTrinhTu tbody tr');
                     data.ketThuc.trinhTu.forEach((tt, index) => {
                        if(rows[index]) {
                            rows[index].querySelector('.seq-work').value = tt.congViec || "";
                            rows[index].querySelector('.seq-safe').value = tt.anToan || "";
                        }
                     });
                }
            }

            document.getElementById('statusMsg').innerText = "ƒê√£ t·∫£i xong!";
            alert("ƒê√£ t·∫£i d·ªØ li·ªáu l·ªánh s·ªë " + soLenh);
        });
    }
</script>

</body>
</html>
