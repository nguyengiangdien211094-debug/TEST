
  <!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω L·ªánh C√¥ng T√°c (C√≥ Danh S√°ch)</title>
    <style>
        /* CSS: ƒê·ªãnh d·∫°ng giao di·ªán gi·ªëng vƒÉn b·∫£n in ·∫•n */
        body { font-family: 'Times New Roman', Times, serif; background-color: #f4f4f4; padding: 20px; font-size: 14px; }
        .main-content { display: flex; max-width: 1200px; margin: 0 auto; }
        .container { flex: 3; background: #fff; padding: 40px; box-shadow: 0 0 15px rgba(0,0,0,0.1); border: 1px solid #ddd; margin-right: 20px; }
        .sidebar { flex: 1; background: #fff; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.05); border: 1px solid #ddd; height: fit-content; }
        
        /* Ti√™u ƒë·ªÅ */
        h1, h2, h3 { text-align: center; font-weight: bold; text-transform: uppercase; margin: 10px 0; }
        h1 { font-size: 18pt; }
        h3 { font-size: 14pt; margin-top: 30px; background: #eee; padding: 5px; text-align: left; border-left: 5px solid #333; }
        
        /* Sidebar */
        .sidebar h4 { margin-top: 0; border-bottom: 2px solid #007bff; padding-bottom: 5px; color: #007bff; }
        #orderList { list-style: none; padding: 0; max-height: 70vh; overflow-y: auto; }
        #orderList li { padding: 8px; border-bottom: 1px dotted #ccc; cursor: pointer; transition: background-color 0.2s; }
        #orderList li:hover { background-color: #e9f0ff; font-weight: bold; color: #007bff; }
        
        /* C√°c tr∆∞·ªùng nh·∫≠p li·ªáu */
        label { font-weight: bold; margin-right: 5px; display: inline-block; }
        input[type="text"], input[type="number"], input[type="datetime-local"], textarea {
            border: 1px solid #ccc; padding: 5px; border-radius: 3px; width: 100%; box-sizing: border-box; font-family: inherit;
        }
        .input-line { border: none; border-bottom: 1px dotted #000; background: transparent; padding: 2px; font-weight: bold; color: #000; }
        .input-line:focus { outline: none; border-bottom: 2px solid #007bff; }
        textarea { height: 60px; resize: vertical; border: 1px solid #bbb; width: 100%; display: block; margin-top: 5px; }

        /* B·∫£ng bi·ªÉu */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; margin-bottom: 15px; }
        th, td { border: 1px solid #000; padding: 8px; text-align: center; vertical-align: middle; }
        th { background-color: #f0f0f0; font-weight: bold; }
        
        /* Thanh c√¥ng c·ª• (N√∫t b·∫•m) */
        .toolbar {
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: rgba(0, 0, 0, 0.85); padding: 15px; text-align: center;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.3); z-index: 1000;
            display: flex; justify-content: center; align-items: center; gap: 15px;
        }
        button {
            padding: 10px 20px; cursor: pointer; border: none; border-radius: 4px; 
            font-weight: bold; color: white; transition: 0.3s;
        }
        .btn-save { background-color: #28a745; }
        .btn-load-list { background-color: #007bff; }
        .btn-new { background-color: #6c757d; }
        
        #statusMsg { color: white; font-style: italic; }
    </style>
</head>
<body>

<div class="main-content">
    
    <div class="sidebar">
        <h4>L·ªÜNH C√îNG T√ÅC ƒê√É L∆ØU</h4>
        <div style="text-align: center; margin-bottom: 10px;">
            <input type="text" id="filterInput" placeholder="L·ªçc theo S·ªë l·ªánh..." style="width: 90%; margin-bottom: 5px;">
        </div>
        <ul id="orderList">
            <li><small>Nh·∫•n n√∫t "Xem Danh S√°ch" ƒë·ªÉ t·∫£i v·ªÅ</small></li>
        </ul>
    </div>
    
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: flex-end;">
            <div style="width: 40%;">
                T√äN ƒê∆†N V·ªä C·∫§P L·ªÜNH:<br>
                <input type="text" id="donViCapLenh" class="input-line" placeholder="...">
            </div>
            <div style="width: 50%; text-align: center;">
                <h2>L·ªÜNH C√îNG T√ÅC</h2>
                S·ªë: <input type="text" id="soLenh" class="input-line" style="width: 100px; text-align: center;" placeholder="S·ªë l·ªánh">
            </div>
        </div>

        <h3>A. PH·∫¶N L∆ØU GI·ªÆ C·ª¶A NG∆Ø·ªúI RA L·ªÜNH</h3>
        
        <div>
            <label>1. Ng∆∞·ªùi ch·ªâ huy tr·ª±c ti·∫øp:</label> 
            <input type="text" id="nguoiChiHuyA" class="input-line" style="width: 50%;"> 
            <label>B·∫≠c ATƒê:</label> <input type="number" id="bacAtA" class="input-line" style="width: 50px;">/5
        </div>

        <div style="margin-top: 10px;">
            <label>2. Nh√¢n vi√™n ƒë∆°n v·ªã c√¥ng t√°c g·ªìm:</label> 
            <input type="number" id="soLuongNguoiA" class="input-line" style="width: 50px;"> ng∆∞·ªùi. 
            <label>Thu·ªôc:</label> <input type="text" id="donViCongTacA" class="input-line" style="width: 40%;">
        </div>

        <p><b>Danh s√°ch nh√¢n vi√™n:</b></p>
        <table id="tableNhanVienA">
            <thead>
                <tr>
                    <th width="10%">TT</th>
                    <th>H·ªç v√† t√™n</th>
                    <th width="20%">B·∫≠c ATƒê</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>1</td><td><input type="text" class="staff-name"></td><td><input type="number" class="staff-safety"></td></tr>
                <tr><td>2</td><td><input type="text" class="staff-name"></td><td><input type="number" class="staff-safety"></td></tr>
                <tr><td>3</td><td><input type="text" class="staff-name"></td><td><input type="number" class="staff-safety"></td></tr>
            </tbody>
        </table>

        <div><label>3. ƒê·ªãa ƒëi·ªÉm/Thi·∫øt b·ªã c√¥ng t√°c:</label> <textarea id="diaDiemA"></textarea></div>
        <div><label>4. N·ªôi dung c√¥ng t√°c:</label> <textarea id="noiDungA"></textarea></div>
        <div><label>5. ƒêi·ªÅu ki·ªán an to√†n ƒëi·ªán:</label> <textarea id="dieuKienA"></textarea></div>
        <div style="margin-top: 10px;"><label>6. Th·ªùi gian b·∫Øt ƒë·∫ßu (D·ª± ki·∫øn):</label> <input type="datetime-local" id="thoiGianBatDauA" style="width: auto;"></div>

        <div style="display: flex; justify-content: flex-end; margin-top: 40px;">
            <div style="width: 40%; text-align: center;">
                <b>Ng∆∞·ªùi ra l·ªánh c√¥ng t√°c</b><br>
                <i>(K√Ω, ghi h·ªç t√™n)</i><br><br><br>
                <input type="text" id="kyNguoiRaLenhA" class="input-line" style="text-align: center;" placeholder="H·ªç t√™n ng∆∞·ªùi k√Ω">
            </div>
        </div>

        <hr style="margin: 40px 0; border-top: 2px dashed #999;">

        <h3>B. PH·∫¶N GIAO CHO NG∆Ø·ªúI CH·ªà HUY TR·ª∞C TI·∫æP</h3>
        
        <p><b>Danh s√°ch nh√¢n vi√™n v√† thay ƒë·ªïi ng∆∞·ªùi:</b></p>
        <table id="tableNhanVienB">
            <thead>
                <tr><th rowspan="2">TT</th><th rowspan="2">H·ªç t√™n</th><th rowspan="2">B·∫≠c ATƒê</th><th colspan="2">ƒê·∫øn l√†m vi·ªác</th><th colspan="2">R√∫t kh·ªèi</th></tr>
                <tr><th>Th·ªùi gian</th><th>K√Ω t√™n</th><th>Th·ªùi gian</th><th>K√Ω t√™n</th></tr>
            </thead>
            <tbody>
                <tr><td>1</td><td><input type="text" class="b-name"></td><td><input type="number" class="b-safety"></td><td><input type="text" class="b-arr-time"></td><td><input type="text" class="b-arr-sign"></td><td><input type="text" class="b-dep-time"></td><td><input type="text" class="b-dep-sign"></td></tr>
                <tr><td>2</td><td><input type="text" class="b-name"></td><td><input type="number" class="b-safety"></td><td><input type="text" class="b-arr-time"></td><td><input type="text" class="b-arr-sign"></td><td><input type="text" class="b-dep-time"></td><td><input type="text" class="b-dep-sign"></td></tr>
            </tbody>
        </table>

        <div style="margin-top: 15px;"><label>1.6. Th·ªùi gian b·∫Øt ƒë·∫ßu l√†m vi·ªác (Th·ª±c t·∫ø):</label> <input type="datetime-local" id="thoiGianBatDauB" style="width: auto;"></div>

        <h4 style="margin-top: 20px;">2. Th·ª±c hi·ªán l·ªánh</h4>
        <div><label>2.2. Ng∆∞·ªùi gi√°m s√°t an to√†n:</label> <input type="text" id="nguoiGiamSat" class="input-line" style="width: 40%;"></div>
        
        <h4 style="margin-top: 20px;">3. K·∫øt th√∫c c√¥ng t√°c</h4>
        <div><label>ƒê∆°n v·ªã l√†m xong c√¥ng vi·ªác l√∫c:</label> <input type="datetime-local" id="thoiGianKetThuc" style="width: auto;"></div>
        <div style="margin-top: 5px;"><label>ƒê√£ b√°o cho √¥ng (b√†):</label> <input type="text" id="baoCaoCho" class="input-line" style="width: 30%;"></div>

        <div style="display: flex; justify-content: space-around; margin-top: 40px;">
            <div style="width: 40%; text-align: center;">
                <b>Ng∆∞·ªùi ch·ªâ huy tr·ª±c ti·∫øp</b><br>
                <i>(K√Ω, ghi h·ªç t√™n)</i><br><br><br>
                <input type="text" id="kyNguoiChiHuyCuoi" class="input-line">
            </div>
            <div style="width: 40%; text-align: center;">
                <b>Ng∆∞·ªùi ra l·ªánh c√¥ng t√°c</b><br>
                <i>(ƒê√£ ki·ªÉm tra, k√Ω t√™n)</i><br><br><br>
                <input type="text" id="kyNguoiRaLenhCuoi" class="input-line">
            </div>
        </div>
    </div>
</div>

<div style="height: 100px;"></div> <div class="toolbar">
    <span id="statusMsg">S·∫µn s√†ng</span>
    <button class="btn-load-list" onclick="loadOrderList()">üìã Xem Danh S√°ch</button>
    <button class="btn-save" onclick="saveData()">üíæ L∆∞u L·ªánh</button>
    <button class="btn-new" onclick="resetForm()">‚ûï T·∫°o M·ªõi/X√≥a Form</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
    // --- 1. C·∫§U H√åNH FIREBASE (B·∫†N PH·∫¢I THAY TH·∫æ PH·∫¶N N√ÄY) ---
    const firebaseConfig = {
  apiKey: "AIzaSyBma2XkXfjWW4RkLCLSvK43c4bE5a6-clI",
  authDomain: "test1-9af7b.firebaseapp.com",
  projectId: "test1-9af7b",
  storageBucket: "test1-9af7b.firebasestorage.app",
  messagingSenderId: "394181075902",
  appId: "1:394181075902:web:90c052212c7b9f111b4fef"
};

    // Kh·ªüi t·∫°o Firebase
    let db;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
        document.getElementById('statusMsg').innerText = "ƒê√£ k·∫øt n·ªëi Firebase.";
    } catch (e) {
        console.error("L·ªói Firebase:", e);
        document.getElementById('statusMsg').innerText = "L·ªñI C·∫§U H√åNH FIREBASE!";
    }

    // --- 2. H√ÄM L∆ØU D·ªÆ LI·ªÜU ---
    function saveData() {
        if (!db) return;
        const soLenh = document.getElementById('soLenh').value.trim();
        if (!soLenh) { alert("Vui l√≤ng nh·∫≠p S·ªê L·ªÜNH!"); return; }

        document.getElementById('statusMsg').innerText = "ƒêang l∆∞u...";

        // H√†m thu th·∫≠p d·ªØ li·ªáu b·∫£ng A (R√∫t g·ªçn)
        const getStaffListA = () => Array.from(document.querySelectorAll('#tableNhanVienA tbody tr')).map(row => ({
            ten: row.querySelector('.staff-name').value,
            bac: row.querySelector('.staff-safety').value
        })).filter(item => item.ten);

        const data = {
            donViCapLenh: document.getElementById('donViCapLenh').value,
            phanA: {
                nguoiChiHuy: document.getElementById('nguoiChiHuyA').value,
                bacAt: document.getElementById('bacAtA').value,
                diaDiem: document.getElementById('diaDiemA').value,
                noiDung: document.getElementById('noiDungA').value,
                thoiGianBatDau: document.getElementById('thoiGianBatDauA').value,
                nhanVien: getStaffListA()
            },
            phanB: {
                thoiGianThucTe: document.getElementById('thoiGianBatDauB').value,
                nguoiGiamSat: document.getElementById('nguoiGiamSat').value,
                thoiGianKetThuc: document.getElementById('thoiGianKetThuc').value,
                baoCaoCho: document.getElementById('baoCaoCho').value,
                kyChiHuy: document.getElementById('kyNguoiChiHuyCuoi').value,
                kyRaLenh: document.getElementById('kyNguoiRaLenhCuoi').value,
            },
            meta: {
                id: soLenh,
                ngayLuu: new Date().toISOString()
            }
        };

        db.ref('LenhCongTac/' + soLenh).set(data)
            .then(() => {
                document.getElementById('statusMsg').innerText = "ƒê√£ l∆∞u th√†nh c√¥ng!";
                alert("L∆∞u th√†nh c√¥ng l·ªánh s·ªë: " + soLenh);
                loadOrderList(); // C·∫≠p nh·∫≠t danh s√°ch sau khi l∆∞u
            })
            .catch((error) => {
                alert("L·ªói: " + error.message);
                document.getElementById('statusMsg').innerText = "L·ªói khi l∆∞u";
            });
    }

    // --- 3. H√ÄM T·∫¢I D·ªÆ LI·ªÜU T·ª™ ID ---
    function loadData(soLenh) {
        if (!db || !soLenh) return;
        document.getElementById('statusMsg').innerText = `ƒêang t·∫£i l·ªánh ${soLenh}...`;

        db.ref('LenhCongTac/' + soLenh).once('value').then((snapshot) => {
            const data = snapshot.val();
            if (!data) {
                alert("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho l·ªánh s·ªë: " + soLenh);
                document.getElementById('statusMsg').innerText = "Kh√¥ng t√¨m th·∫•y";
                return;
            }
            
            // ƒêi·ªÅn l·∫°i d·ªØ li·ªáu v√†o form
            fillForm(soLenh, data);
            document.getElementById('statusMsg').innerText = `ƒê√£ t·∫£i xong l·ªánh ${soLenh}.`;
        }).catch(e => {
            alert("L·ªói t·∫£i d·ªØ li·ªáu: " + e.message);
            document.getElementById('statusMsg').innerText = "L·ªói t·∫£i d·ªØ li·ªáu";
        });
    }
    
    // --- 4. H√ÄM HI·ªÇN TH·ªä DANH S√ÅCH ---
    function loadOrderList() {
        if (!db) return;
        document.getElementById('statusMsg').innerText = "ƒêang t·∫£i danh s√°ch...";
        
        // L·∫•y t·∫•t c·∫£ c√°c kh√≥a (key) trong node 'LenhCongTac'
        db.ref('LenhCongTac').once('value').then(snapshot => {
            const listElement = document.getElementById('orderList');
            listElement.innerHTML = ''; // X√≥a danh s√°ch c≈©
            
            const orders = [];
            snapshot.forEach(childSnapshot => {
                const soLenh = childSnapshot.key;
                const data = childSnapshot.val();
                orders.push({ soLenh, data });
            });
            
            if (orders.length === 0) {
                listElement.innerHTML = '<li><small>Ch∆∞a c√≥ l·ªánh c√¥ng t√°c n√†o ƒë∆∞·ª£c l∆∞u.</small></li>';
                document.getElementById('statusMsg').innerText = "Danh s√°ch tr·ªëng.";
                return;
            }
            
            orders.sort((a, b) => { // S·∫Øp x·∫øp theo ng√†y l∆∞u m·ªõi nh·∫•t
                const dateA = new Date(a.data.lastUpdated || a.data.meta.ngayLuu);
                const dateB = new Date(b.data.lastUpdated || b.data.meta.ngayLuu);
                return dateB - dateA;
            });

            // Hi·ªÉn th·ªã danh s√°ch
            orders.forEach(order => {
                const li = document.createElement('li');
                const saveDate = order.data.meta.ngayLuu ? new Date(order.data.meta.ngayLuu).toLocaleDateString('vi-VN') : '---';
                li.innerHTML = `<b>${order.soLenh}</b> - <small>L∆∞u ng√†y: ${saveDate}</small>`;
                li.setAttribute('data-solenh', order.soLenh);
                li.onclick = () => loadData(order.soLenh); // G·∫Øn s·ª± ki·ªán click ƒë·ªÉ t·∫£i form
                listElement.appendChild(li);
            });
            
            document.getElementById('statusMsg').innerText = `ƒê√£ t·∫£i ${orders.length} l·ªánh.`;
        }).catch(e => {
            alert("L·ªói t·∫£i danh s√°ch: " + e.message);
            document.getElementById('statusMsg').innerText = "L·ªói t·∫£i danh s√°ch";
        });
    }

    // --- 5. H√ÄM ƒêI·ªÄN D·ªÆ LI·ªÜU V√ÄO FORM ---
    function fillForm(soLenh, data) {
        document.getElementById('soLenh').value = soLenh;
        document.getElementById('donViCapLenh').value = data.donViCapLenh || "";
        
        // Ph·∫ßn A
        if (data.phanA) {
            document.getElementById('nguoiChiHuyA').value = data.phanA.nguoiChiHuy || "";
            document.getElementById('bacAtA').value = data.phanA.bacAt || "";
            document.getElementById('diaDiemA').value = data.phanA.diaDiem || "";
            document.getElementById('noiDungA').value = data.phanA.noiDung || "";
            document.getElementById('thoiGianBatDauA').value = data.phanA.thoiGianBatDau || "";
            document.getElementById('kyNguoiRaLenhA').value = data.phanA.nguoiKy || "";
            
            // ƒêi·ªÅn b·∫£ng nh√¢n vi√™n A
            const staffInputs = document.querySelectorAll('#tableNhanVienA tbody tr input');
            staffInputs.forEach(input => input.value = ''); // X√≥a c≈©
            if(data.phanA.nhanVien) {
                data.phanA.nhanVien.forEach((nv, index) => {
                    const row = document.querySelectorAll('#tableNhanVienA tbody tr')[index];
                    if(row) {
                        row.querySelector('.staff-name').value = nv.ten || "";
                        row.querySelector('.staff-safety').value = nv.bac || "";
                    }
                });
            }
        }
        
        // Ph·∫ßn B
        if (data.phanB) {
            document.getElementById('thoiGianBatDauB').value = data.phanB.thoiGianThucTe || "";
            document.getElementById('nguoiGiamSat').value = data.phanB.nguoiGiamSat || "";
            document.getElementById('thoiGianKetThuc').value = data.phanB.thoiGianKetThuc || "";
            document.getElementById('baoCaoCho').value = data.phanB.baoCaoCho || "";
            document.getElementById('kyNguoiChiHuyCuoi').value = data.phanB.kyChiHuy || "";
            document.getElementById('kyNguoiRaLenhCuoi').value = data.phanB.kyRaLenh || "";
        }
    }

    // --- 6. H√ÄM L·ªåC DANH S√ÅCH ---
    document.getElementById('filterInput').addEventListener('keyup', function() {
        const filter = this.value.toUpperCase();
        const li = document.getElementById('orderList').getElementsByTagName('li');
        for (let i = 0; i < li.length; i++) {
            const text = li[i].getAttribute('data-solenh') || li[i].innerText;
            if (text.toUpperCase().indexOf(filter) > -1) {
                li[i].style.display = "";
            } else {
                li[i].style.display = "none";
            }
        }
    });
    
    // --- 7. H√ÄM X√ìA FORM ---
    function resetForm() {
        if(confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a tr·∫Øng t·∫•t c·∫£ d·ªØ li·ªáu hi·ªán t·∫°i tr√™n form?")) {
            document.querySelectorAll('.container input, .container textarea').forEach(e => e.value = '');
            document.getElementById('statusMsg').innerText = "S·∫µn s√†ng (Form ƒë√£ ƒë∆∞·ª£c x√≥a tr·∫Øng).";
        }
    }
</script>

</body>
</html>
